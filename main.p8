pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
--main

-- screen values
screen_title=0
screen_intro=1 -- not implemented
screen_game=2

frame_count=0

function _init()
	screen=screen_title
	setup_clouds()
	
	enemy_setup()
	make_enemy()
end

function _update60()
	update_game()
end

background=0
function _draw()
	cls(background)
	frame_count+=1
	if screen==screen_title then
		draw_title()
	end
	if screen==screen_intro then
		draw_intro()
	end
	if screen==screen_game then
		draw_game()
	end
end

-- title
function draw_title()
	print("cupid cupid!", 4, 64-8)
	if(frame_count%25<10) then
		print("[press ❎ to play]", 4, 64+8)
	end
		
	if(btn(❎)) then
		screen=screen_game
	end
end

-- intro
function draw_intro()
	
end

-- game
function draw_game()
	cls(12)
	foreach(clouds,draw_cloud)
	draw_particles()
	foreach(arrows,draw_arrow)
	draw_player(player)
	
	foreach(enemies,draw_enemy)
end

function update_game()
	update_player(player)
	foreach(arrows,update_arrow)
end

-->8
--player

player_reload_cooldown=10

player={
	x=20,
	y=64,
	dx=0,
	dy=0,
	flap=0,
	cooldown=0
}

friction=0.65
function update_player(p)
	p.dx*=friction
	p.dy*=friction

	--move
	local speed=2
	if btn(⬆️) then p.dy=-speed end
	if btn(⬇️) then p.dy=speed end
	if btn(⬅️) then p.dx=-speed end
	if btn(➡️) then p.dx=speed end

	--normalize
	if p.dx*p.dy != 0 then
		p.dx*=0.707
		p.dy*=0.707
	end
	p.x+=p.dx
	p.y+=p.dy

	--collide
	if p.x <=0 then p.x=0 end
	if p.x >=113 then p.x=113 end
	if p.y <=0 then p.y=0 end
	if p.y >=113 then p.y=113 end
	
	p.cooldown-=1
	if btnp(❎) and p.cooldown<=0 then
		sfx(0)
		p.cooldown=player_reload_cooldown
		make_arrow(p.x,p.y) 
	end
	
end

function draw_player(p)
	--wings
	p.flap+=0.25
	if(p.flap>=4)p.flap=0
	local pf=flr(p.flap)
	spr(35+pf,p.x+1,p.y+4)

	--body
	local y_offs=0
	if(p.flap==2)y_offs=1
	local p_spr=3
	if(p.cooldown>0)p_spr=7
	if(p.cooldown>3)p_spr=5
	local x_offs=0
	if(p.cooldown==player_reload_cooldown)x_offs=1
	spr(p_spr,p.x-x_offs,p.y-y_offs,2,2)
end


--projectile logic

arrow_speed=3
arrows={}

function make_arrow(x,y)
	local arrow={}
	arrow.x=x+8
	arrow.y=y+8
	arrow.w=8
	arrow.h=5
	arrow.sprite=5
	add(arrows,arrow)
end

function update_arrow(arrow)
	arrow.x+=arrow_speed
	if(arrow.x>130)del(arrows,arrow)
end

function draw_arrow(arrow)
	spr(33,arrow.x-4,arrow.y-3,2,1)
	if(frame_count%4==0)add_particle(arrow.x,arrow.y,arrow_speed*0.5,20,8)
end
-->8
--enemies

function enemy_setup()
	enemies={}
end

function make_enemy()
	local e={}
	e.x=90
	e.y=64
	e.w=8
	e.h=8
	e.health=2
	e.sprite=9
	add(enemies,e)
end

function update_enemy(e)
	
end

function draw_enemy(e)
	spr(e.sprite,e.x,e.y)
end
-->8
--background
clouds={}
function setup_clouds()
	local cloud_types={
		{s=64,w=2,h=2},
		{s=66,w=3,h=1},
	}
	local cloud_count=10
	for i=0,cloud_count do
		local t=cloud_types[flr(rnd(#cloud_types))+1]
		local dx=-(1+i/cloud_count)
		add(clouds,{
			x=rnd(128),
			y=120-50*(rnd()^2),
			s=t.s,w=t.w,h=t.h,
			o=i/cloud_count,dx=dx
		})
	end
end

function draw_cloud(c)
	if(c.o<0.3 and frame_count%2==0)return
	spr(c.s,c.x,c.y,c.w,c.h)
	-- rectfill(c.x,c.y,10,10,8)
	c.x+=c.dx
end
-->8
--particles
p_arr={}
function add_particle(x, y, dx, lifetime, col)
	add(p_arr, {
		x=x, y=y, col=col,
		lifetime=lifetime,
		dx=dx+rnd(1)-0.5,
		dy=rnd(1)-0.5,
	})
end

function draw_particles()
	for p in all(p_arr) do
		--apply velocity
		p.x+=p.dx
		p.y+=p.dy
		--add gravity (only y component)
		p.dy+=0.01

		--lifetime:
		--  [8, inf) => show
		--  [0, 8) => blink (50% opacity)
		p.lifetime-=1
		if p.lifetime>8 or (p.lifetime<8 and p.lifetime%2==0) do
			-- pset(p.x,p.y,p.col)
			line(p.x-1,p.y-1,p.x-1,p.y,p.col)
			line(p.x,p.y,p.x,p.y+1,p.col)
			line(p.x+1,p.y-1,p.x+1,p.y,p.col)
			if(p.lifetime<=0)del(p_arr,p)
		end
	end
end
-->8
--collision

function collision(a,b)
	return not (a.x>b.x+b.w or a.y>b.y+b.h or a.x+a.w<b.x or a.y+a.h<b.y)
end
__gfx__
000000000000000000000000000000aaaaa00000000000aaaaa40000000000aaaaa0000088800999988112280000000000000000000000000000000000000000
00000000000000aaaa00000000000aaaaa4a000000000aaaaaa7400000000aaaaa4a0000888e0999991112220000000000000000000000000000000000000000
0070070000000aaaaaa000000000aaaaa7a400000000aaaaaaa740000000aaaaaa74400088eee999911918220000000000000000000000000000000000000000
0007700000000aaaaaa000000000aaff7fff40000000aafffff740000000aaffff7f400080eeee99911198220000000000000000000000000000000000000000
0007700000000aaaaaa000000000aaf7ff1f40000000aaf1ff1704000000aaf1f71f040000eeecc0999992220000000000000000000000000000000000000000
00700700006777aaaa7776000000af71ff1f04000000aff1ff1704000000aff1f71f0400bbcccccc99eee22d0000000000000000000000000000000000000000
00000000077777ffff7777700000097ffffe040000000feffff7040000000feff7fe0400bbbcccc6eeededdd0000000000000000000000000000000000000000
000000000777677ff77677700000fff4fff00400000009fffff70400000000ff97f00400bbbbcc66ee8ddddd0000000000000000000000000000000000000000
0000000077776777777677770000fff4fffff5000000fff4fff7f50000000ffff4f7f50000000000000000000000000000000000000000000000000000000000
0040000076767767767767670000007ffffff5000000fff4fff7f50000000ffff4f7f50000000000000000000000000000000000000000000000000000000000
00d40000767677677677676700000076660004000000006666070400000000666700040000000000000000000000000000000000000000000000000000000000
00d400007607767dd767706700000067660040000000006666070400000000666700040000000000000000000000000000000000000000000000000000000000
00d04000700076f00f67000700000ff67f00400000000ff6ff07400000000ff6ff70400000000000000000000000000000000000000000000000000000000000
00d0400000000ff00ff000000000fff0f70400000000fff0ff0740000000fff0ff74400000000000000000000000000000000000000000000000000000000000
00d0400000000000000000000000ff0ff04000000000ff0ff00740000000ff0ff040000000000000000000000000000000000000000000000000000000000000
0d004000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000
0d005000000000000000000007700000077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0d00500088e0000008e0000076770000767700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0d040000888eeeeeee8e000077670000776700000007000000070000000000000000000000000000000000000000000000000000000000000000000000000000
0d040000088888888888800077677000777670000077700000777000000000000000000000000000000000000000000000000000000000000000000000000000
0d400000888222222282000077767000677670000777700000777000000000000000000000000000000000000000000000000000000000000000000000000000
0d400000882000000820000067077000600770000776700007767000000000000000000000000000000000000000000000000000000000000000000000000000
04000000000000000000000060000000000000007667000077670000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000006770000066770000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000333333330000333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000033bbbbbb330033bbbbbb33333333003333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00003bbbbbbbb3003bbbbbbb3bbbbbb3333bb3300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03333bbbbbbbb3303bbbbbb3bbbbbbbbbbbbbb330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33bb3bbbbbbbbb3333bbbbbbbbbbbbbbbbbbbbb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3bbbb3bbbbbbbbb30333bbbbbbbbbbbbbbbbbb330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3bbbbbbbbbbbbbb3000333bbbbbbbbbbbbbbb3300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3bbbbbbbbbbbbbb30000033333333333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33bbbbbbbbbbbbb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03bbbbbb3bbbbbb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0333bbb333bbbb330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00033333033333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66676677cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77766767cc677ccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777776666777760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777676677777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77766776677777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6766776c677777760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c66666cc667776660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccc6666cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00020000296700000022650000001a6400000010620000000a6100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00f200001055013550145501555017550185501a5501660019600206001b60016600136001260013600186001d600206001a6001a6001f6001f6002160024600296002160021600276001f60022600226003d700
